#include "pwm.h"

TIM_HandleTypeDef 	TIM1_Handler;      	//???????? 
TIM_OC_InitTypeDef 	TIM1_CH1Handler;	//CH1??????
TIM_OC_InitTypeDef 	TIM1_CH2NHandler;	//CH2N?????????????????
TIM_BreakDeadTimeConfigTypeDef TIM1_DeadTimeHandler; //??????????

// ?????????????????????????
volatile uint32_t pwm_burst_count = 0;
volatile uint8_t pwm_burst_active = 0;

void TIM1_PWM_Init(u16 arr,u16 psc)
{  
    // 1. ?????????????
    TIM1_Handler.Instance=TIM1;          
    TIM1_Handler.Init.Prescaler=psc;        
    TIM1_Handler.Init.CounterMode=TIM_COUNTERMODE_UP;
    TIM1_Handler.Init.Period=arr;           
    TIM1_Handler.Init.ClockDivision=TIM_CLOCKDIVISION_DIV1;
    TIM1_Handler.Init.RepetitionCounter=0;  // ????????0?????????????
    HAL_TIM_PWM_Init(&TIM1_Handler);       	

    // 2. ????CH1??PA8????????PWM1?????????????????
    TIM1_CH1Handler.OCMode=TIM_OCMODE_PWM1; // PWM1????CNT<CCR???????????
    TIM1_CH1Handler.Pulse=arr/2;            //????50%
    TIM1_CH1Handler.OCPolarity=TIM_OCPOLARITY_HIGH; //??????????
    TIM1_CH1Handler.OCFastMode=TIM_OCFAST_DISABLE;
    TIM1_CH1Handler.OCIdleState=TIM_OCIDLESTATE_SET; //?????????????????????
    HAL_TIM_PWM_ConfigChannel(&TIM1_Handler,&TIM1_CH1Handler,TIM_CHANNEL_1);
	
    // 3. ????CH2N??PB0????????PWM1?????????????????
    TIM1_CH2NHandler.OCMode=TIM_OCMODE_PWM2; //??CH1???
    TIM1_CH2NHandler.Pulse=arr/2;            //??CH1?????
    TIM1_CH2NHandler.OCNPolarity=TIM_OCNPOLARITY_HIGH; //?????????????????
    TIM1_CH2NHandler.OCFastMode=TIM_OCFAST_DISABLE;
    TIM1_CH2NHandler.OCNIdleState=TIM_OCNIDLESTATE_SET; //?????????????????????
    HAL_TIM_PWM_ConfigChannel(&TIM1_Handler,&TIM1_CH2NHandler,TIM_CHANNEL_2);
	
    // 4. ????????
    TIM1_DeadTimeHandler.OffStateRunMode=TIM_OSSR_DISABLE;
    TIM1_DeadTimeHandler.OffStateIDLEMode=TIM_OSSI_DISABLE;
    TIM1_DeadTimeHandler.LockLevel=TIM_LOCKLEVEL_OFF;
    TIM1_DeadTimeHandler.DeadTime=2; //???????????
    TIM1_DeadTimeHandler.BreakState=TIM_BREAK_DISABLE;
    TIM1_DeadTimeHandler.BreakPolarity=TIM_BREAKPOLARITY_HIGH;
    TIM1_DeadTimeHandler.AutomaticOutput=TIM_AUTOMATICOUTPUT_ENABLE;
    HAL_TIMEx_ConfigBreakDeadTime(&TIM1_Handler,&TIM1_DeadTimeHandler);
    
    // 5. ???????????
    __HAL_TIM_ENABLE_IT(&TIM1_Handler, TIM_IT_UPDATE);
}

//?????????????????????????????
//???????HAL_TIM_PWM_Init()????
//htim:????????
//?????????????????????????????
void HAL_TIM_PWM_MspInit(TIM_HandleTypeDef *htim)
{
	GPIO_InitTypeDef GPIO_Initure;
	
    if(htim->Instance==TIM1)
	{
		__HAL_RCC_TIM1_CLK_ENABLE();			//???????1???
		
		__HAL_RCC_GPIOA_CLK_ENABLE();			//????GPIOA???
		__HAL_RCC_GPIOB_CLK_ENABLE();			//????GPIOB???
		
		//????PA8?TIM1_CH1?????????
		GPIO_Initure.Pin=GPIO_PIN_8;            
		GPIO_Initure.Mode=GPIO_MODE_AF_PP;  	//???????????
		GPIO_Initure.Pull=GPIO_PULLDOWN;        //????
		GPIO_Initure.Speed=GPIO_SPEED_HIGH;     //????
		GPIO_Initure.Alternate=GPIO_AF1_TIM1;	//PA8?????TIM1_CH1
		HAL_GPIO_Init(GPIOA,&GPIO_Initure); 	
		
		//????PB0?TIM1_CH2N???????????
		GPIO_Initure.Pin=GPIO_PIN_0;            
		GPIO_Initure.Alternate=GPIO_AF1_TIM1;	//PB0?????TIM1_CH2N
		HAL_GPIO_Init(GPIOB,&GPIO_Initure); 	
		
		// ????NVIC??????TIM1????????
		HAL_NVIC_SetPriority(TIM1_UP_TIM10_IRQn, 0, 0);
		HAL_NVIC_EnableIRQ(TIM1_UP_TIM10_IRQn);
	}
}

//????TIM1???1??????
//compare:??????0~arr??
void TIM_SetTIM1Compare1(u32 compare)
{
	TIM1->CCR1=compare; 
}

//?????1?????????
void TIM1_UP_TIM10_IRQHandler(void)
{
    if(__HAL_TIM_GET_FLAG(&TIM1_Handler, TIM_FLAG_UPDATE) != RESET)
    {
        if(__HAL_TIM_GET_IT_SOURCE(&TIM1_Handler, TIM_IT_UPDATE) != RESET)
        {
            __HAL_TIM_CLEAR_IT(&TIM1_Handler, TIM_IT_UPDATE);
            
            // ???????????
            if(pwm_burst_active && pwm_burst_count > 0)
            {
                pwm_burst_count--;
                
                // ????????0???PWM
                if(pwm_burst_count == 0)
                {
                    Stop_Pwm();
                    pwm_burst_active = 0;
                }
            }
        }
    }
}

void Start_Pwm(void)
{   
  	HAL_TIMEx_PWMN_Start(&TIM1_Handler, TIM_CHANNEL_2); //????CH2N
    HAL_TIM_PWM_Start(&TIM1_Handler,TIM_CHANNEL_1); //?????????PWM

}
void Stop_Pwm(void)
{
    HAL_TIMEx_PWMN_Stop(&TIM1_Handler,TIM_CHANNEL_2); //?????????PWM	
    HAL_TIM_PWM_Stop(&TIM1_Handler,TIM_CHANNEL_1); //????????PWM

}

// ?????????????????????
void Start_Pwm_Burst(uint32_t pulse_count)
{
    // ???????????
    pwm_burst_count = pulse_count;
    pwm_burst_active = 1;
    
    // ????PWM
    __HAL_TIM_SET_COUNTER(&TIM1_Handler, 0);
    Start_Pwm();
}

